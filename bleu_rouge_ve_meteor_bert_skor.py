# -*- coding: utf-8 -*-
"""BLEU, ROUGE ve METEOR SKOR.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Y_TT7yyWtwGkmcYN7BXiOq1yasKbLlLo
"""

import pandas as pd

# DosyalarÄ± yÃ¼kle ve sÃ¼tun isimlerini gÃ¶ster
m2m100 = pd.read_csv('m2m100_translations_500.csv')
nllb = pd.read_csv('nllb_results_nllb-200-distilled-600M.csv')
helsinki = pd.read_csv('translated_sentences_final.csv')

print("m2m100 sÃ¼tunlarÄ±:", m2m100.columns.tolist())
print("nllb sÃ¼tunlarÄ±:", nllb.columns.tolist())
print("helsinki sÃ¼tunlarÄ±:", helsinki.columns.tolist())

import pandas as pd
import numpy as np
from nltk.translate.bleu_score import sentence_bleu, SmoothingFunction
from rouge_score import rouge_scorer
from nltk.translate.meteor_score import meteor_score
import nltk
from nltk.tokenize import word_tokenize
from google.colab import files
import ipywidgets as widgets
from IPython.display import display, clear_output
from bert_score import score
import warnings
warnings.filterwarnings('ignore')

# Gerekli paketlerin yÃ¼klenmesi
!pip install bert-score rouge-score nltk pandas numpy ipywidgets
nltk.download('punkt')
nltk.download('wordnet')
nltk.download('omw-1.4')

# Verilerin yÃ¼klenmesi (Ã–RNEK - KENDÄ° DOSYALARINIZA GÃ–RE DÃœZENLEYÄ°N)
# Bu kÄ±sÄ±mda kendi dosya yapÄ±nÄ±za uygun dÃ¼zenlemeler yapmalÄ±sÄ±nÄ±z
try:
    # Ã–rnek yÃ¼kleme - gerÃ§ek dosya yapÄ±nÄ±za gÃ¶re deÄŸiÅŸtirin
    m2m100 = pd.read_csv('m2m100_translations_500.csv')
    nllb = pd.read_csv('nllb_results_nllb-200-distilled-600M.csv')
    helsinki = pd.read_csv('translated_sentences_final.csv')
    reference_df = pd.read_csv('reference_translations.csv')  # TÃ¼rkÃ§e referans Ã§eviriler

    # SÃ¼tun isimlerini dÃ¼zenleme (kendi dosyalarÄ±nÄ±za gÃ¶re ayarlayÄ±n)
    data = pd.DataFrame({
        'reference': reference_df['turkce_ceviri'],  # TÃ¼rkÃ§e referans Ã§eviriler
        'm2m100': m2m100['Ã‡eviri'],
        'nllb': nllb['Ã§eviri'],
        'helsinki': helsinki['Turkish_Translation']
    }).head(50)  # Ä°lk 50 cÃ¼mle

except Exception as e:
    print(f"Dosya yÃ¼kleme hatasÄ±: {str(e)}")
    print("LÃ¼tfen dosya yollarÄ±nÄ± ve sÃ¼tun isimlerini kontrol edin")
    raise

# TÃ¼rkÃ§e iÃ§in Ã¶zel metin temizleme fonksiyonu
def clean_text(text):
    if not isinstance(text, str):
        return ""
    text = text.lower().strip()
    # TÃ¼rkÃ§e karakter dÃ¶nÃ¼ÅŸÃ¼mÃ¼
    turkish_chars = {'Ä±':'i', 'ÄŸ':'g', 'Ã¼':'u', 'ÅŸ':'s', 'Ã¶':'o', 'Ã§':'c'}
    for char, replacement in turkish_chars.items():
        text = text.replace(char, replacement)
    # Noktalama temizliÄŸi
    for punct in '.,!?;:"()[]{}':
        text = text.replace(punct, ' ')
    return ' '.join(text.split())

# GeliÅŸmiÅŸ metrik hesaplama fonksiyonu
def calculate_metrics(reference, hypothesis):
    # Temizleme ve tokenizasyon
    ref_clean = clean_text(reference)
    hyp_clean = clean_text(hypothesis)

    ref_tokens = word_tokenize(ref_clean) if ref_clean else []
    hyp_tokens = word_tokenize(hyp_clean) if hyp_clean else []

    if not ref_tokens or not hyp_tokens:
        return {metric: 0 for metric in ['BLEU', 'ROUGE-1', 'ROUGE-2', 'ROUGE-L', 'METEOR', 'BERTScore']}

    # BLEU
    try:
        smoothie = SmoothingFunction().method4
        bleu = sentence_bleu([ref_tokens], hyp_tokens, smoothing_function=smoothie)
    except:
        bleu = 0

    # ROUGE
    try:
        scorer = rouge_scorer.RougeScorer(['rouge1', 'rouge2', 'rougeL'], use_stemmer=True)
        rouge_scores = scorer.score(ref_clean, hyp_clean)
    except:
        rouge_scores = {'rouge1': type('', (), {'fmeasure': 0}),
                       'rouge2': type('', (), {'fmeasure': 0}),
                       'rougeL': type('', (), {'fmeasure': 0})}

    # METEOR
    try:
        meteor = meteor_score([ref_tokens], hyp_tokens)
    except:
        meteor = 0

    # BERTScore
    try:
        _, _, bert_f1 = score([hyp_clean], [ref_clean], lang='tr')
        bert_score = bert_f1.mean().item()
    except:
        bert_score = 0

    return {
        'BLEU': bleu,
        'ROUGE-1': rouge_scores['rouge1'].fmeasure,
        'ROUGE-2': rouge_scores['rouge2'].fmeasure,
        'ROUGE-L': rouge_scores['rougeL'].fmeasure,
        'METEOR': meteor,
        'BERTScore': bert_score
    }

# METRÄ°KLERÄ° HESAPLA
print("Metrikler hesaplanÄ±yor...")
metrics = {model: {metric: [] for metric in ['BLEU', 'ROUGE-1', 'ROUGE-2', 'ROUGE-L', 'METEOR', 'BERTScore']}
           for model in ['m2m100', 'nllb', 'helsinki']}

for i, row in data.iterrows():
    for model in ['m2m100', 'nllb', 'helsinki']:
        if pd.isna(row[model]):
            # Eksik Ã§eviri durumu
            for metric in metrics[model].keys():
                metrics[model][metric].append(0)
        else:
            model_metrics = calculate_metrics(row['reference'], row[model])
            for metric, value in model_metrics.items():
                metrics[model][metric].append(value)

# Ortalama metrikler
avg_metrics = {model: {metric: np.mean(values) for metric, values in metrics[model].items()}
               for model in metrics}
results_df = pd.DataFrame(avg_metrics).T

# Ä°NSAN DEÄERLENDÄ°RMESÄ° ARAYÃœZÃœ
human_scores = {model: [] for model in ['m2m100', 'nllb', 'helsinki']}
current_index = 0

# Widgetlar
sentence_display = widgets.Output()
score_buttons = widgets.RadioButtons(
    options=[1, 2, 3, 4, 5],
    description='Puan:',
    disabled=False,
    layout={'width': 'max-content'}
)
model_selector = widgets.Dropdown(
    options=['m2m100', 'nllb', 'helsinki'],
    description='Model:',
    disabled=False
)
next_button = widgets.Button(description="Sonraki", button_style='success')
save_button = widgets.Button(description="SonuÃ§larÄ± Kaydet", button_style='info')
progress = widgets.IntProgress(value=0, max=50, description='Ä°lerleme:')

def display_sentence(index, model):
    with sentence_display:
        clear_output()
        print(f"### CÃ¼mle {index+1}/50 ###")
        print("\nğŸ”¹ Kaynak Metin:")
        print(data.iloc[index]['reference'])
        print(f"\nğŸ”¹ {model.upper()} Ã‡evirisi:")
        print(data.iloc[index][model])
        print("\nDeÄŸerlendirme Kriterleri:")
        print("1: Ã‡ok kÃ¶tÃ¼ - 3: Orta - 5: MÃ¼kemmel")

def on_next_click(b):
    global current_index
    if current_index < 50:
        human_scores[model_selector.value].append(score_buttons.value)
        progress.value += 1
    if current_index < 49:
        current_index += 1
        display_sentence(current_index, model_selector.value)
    else:
        with sentence_display:
            clear_output()
            print("âœ… TÃ¼m deÄŸerlendirmeler tamamlandÄ±!")
        next_button.disabled = True

def on_save_click(b):
    # Ä°nsan puanlarÄ±nÄ± ekle
    human_avg = {model: np.mean(scores) if scores else 0 for model, scores in human_scores.items()}
    final_results = results_df.join(pd.DataFrame.from_dict(human_avg, orient='index', columns=['Human_Score']))

    # SonuÃ§larÄ± gÃ¶ster ve kaydet
    print("\nğŸ” FÄ°NAL SONUÃ‡LAR:")
    display(final_results)
    final_results.to_csv('translation_model_comparison.csv')
    files.download('translation_model_comparison.csv')
    print("\nâœ… SonuÃ§lar 'translation_model_comparison.csv' olarak kaydedildi ve indirildi!")

# EtkileÅŸimleri ayarla
display_sentence(current_index, model_selector.value)
model_selector.observe(lambda c: display_sentence(current_index, c['new']), names='value')
next_button.on_click(on_next_click)
save_button.on_click(on_save_click)

# ArayÃ¼zÃ¼ gÃ¶ster
display(widgets.VBox([
    widgets.HTML("<h2>ğŸš€ Makine Ã‡evirisi Model KarÅŸÄ±laÅŸtÄ±rmasÄ±</h2>"),
    widgets.HBox([model_selector, score_buttons]),
    sentence_display,
    progress,
    widgets.HBox([next_button, save_button])
]))

# Otomatik metrik sonuÃ§larÄ±nÄ± gÃ¶ster
print("\nâ­ OTOMATÄ°K METRÄ°K SONUÃ‡LARI:")
display(results_df)